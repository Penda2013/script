<!-- nano /conf/config.xml -->
<!--  SECTION IPSEC VPN SITE-TO-SITE -->

<ipsec>
  <tunnel>
    <ikeid>1</ikeid>
    <disabled></disabled>
    <remote-gateway>132.207.28.207</remote-gateway>
    <interface>wan</interface>
    <ike-version>ikev2</ike-version>
    <descr>VPN SiteB ➜ SiteA</descr>
    <authentication_method>pre_shared_key</authentication_method>
    <pre-shared-key>MaCleFixeEtSecrete123!</pre-shared-key>
    <myid_type>myaddress</myid_type>
    <peerid_type>peeraddress</peerid_type>
    <mode>main</mode>
    <encryption-algorithm-option>
      <name>aes</name>
      <keylen>256</keylen>
    </encryption-algorithm-option>
    <hash-algorithm-option>sha256</hash-algorithm-option>
    <dhgroup>14</dhgroup>
    <lifetime>28800</lifetime>
    <nat_traversal>on</nat_traversal>
    <auto>start</auto>
    <proposal_check>obey</proposal_check>
    <rekey_time>3600</rekey_time>
    <reauth_time>28800</reauth_time>
  </tunnel>

  <phase2>
    <ikeid>1</ikeid>
    <uniqid>{A1B2C3D4E5F6}</uniqid>
    <mode>tunnel</mode>
    <localid>
      <type>lan</type>
      <address>192.168.1.0</address>
      <netbits>24</netbits>
    </localid>
    <remoteid>
      <type>address</type>
      <address>192.168.0.0</address>
      <netbits>24</netbits>
    </remoteid>
    <protocol>esp</protocol>
    <encryption-algorithm-option>
      <name>aes</name>
      <keylen>256</keylen>
    </encryption-algorithm-option>
    <hash-algorithm-option>sha256</hash-algorithm-option>
    <pfsgroup>14</pfsgroup>
    <lifetime>3600</lifetime>
    <descr>VPN SiteB↔SiteA Phase2</descr>
  </phase2>
</ipsec>

<!--  SECTION FIREWALL RULES -->

<filter>
  <!--  Règle IPsec : autoriser trafic sortant vers Site A  -->
  <rule>
    <type>pass</type>
    <interface>ipsec</interface>
    <ipprotocol>inet</ipprotocol>
    <protocol>any</protocol>
    <source>
      <network>192.168.1.0/24</network>
    </source>
    <destination>
      <network>192.168.0.0/24</network>
    </destination>
    <descr>Allow SiteB → SiteA (IPsec)</descr>
  </rule>

  <!--  Règle IPsec : autoriser trafic entrant de Site A  -->
  <rule>
    <type>pass</type>
    <interface>ipsec</interface>
    <ipprotocol>inet</ipprotocol>
    <protocol>any</protocol>
    <source>
      <network>192.168.0.0/24</network>
    </source>
    <destination>
      <network>192.168.1.0/24</network>
    </destination>
    <descr>Allow SiteA → SiteB (IPsec)</descr>
  </rule>
</filter>

<!--  SECTION NAT OUTBOUND -->

<nat>
  <outbound>
    <mode>hybrid</mode>
    <rule>
      <source>
        <network>192.168.1.0/24</network>
      </source>
      <destination>
        <network>192.168.0.0/24</network>
      </destination>
      <interface>wan</interface>
      <protocol>any</protocol>
      <descr>No NAT to SiteA (192.168.1.0/24→192.168.0.0/24)</descr>
      <nonat>yes</nonat>
    </rule>
  </outbound>
</nat>

<!--  SERVICE IPSec activé -->

<installedpackages>
  <strongswan>
    <config>
      <enable>1</enable>
    </config>
  </strongswan>
</installedpackages>



<!-- Recharge conf : /etc/rc.reload_all et ipsec restart -->

